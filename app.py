import streamlit as st
import datetime
from collections import Counter

# --- æ•°å€¤å‡¦ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
def reduce_number(n):
    while n > 9 and n not in [11, 22, 33]:
        n = sum(int(d) for d in str(n))
    return n

def char_to_num(c):
    table = {
        'A':1,'B':2,'C':3,'D':4,'E':5,'F':6,'G':7,'H':8,'I':9,
        'J':1,'K':2,'L':3,'M':4,'N':5,'O':6,'P':7,'Q':8,'R':9,
        'S':1,'T':2,'U':3,'V':4,'W':5,'X':6,'Y':7,'Z':8
    }
    return table.get(c.upper(), 0)

def calculate_life_path_number(birthdate):
    return reduce_number(sum(int(d) for d in birthdate.strftime('%Y%m%d')))

def calculate_birth_day_number(day):
    return reduce_number(day)

def calculate_expression_number(name):
    return reduce_number(sum(char_to_num(c) for c in name if c.isalpha()))

def calculate_soul_urge_number(name):
    return reduce_number(sum(char_to_num(c) for c in name if c.upper() in "AEIOU"))

def evaluate_compatibility(n1, n2):
    distance = abs(n1 - n2)
    if n1 == n2:
        return "ä¼¼ã™ãã¦è¡çªã‚‚ï¼æ·±ã„ç†è§£"
    elif distance == 1:
        return "ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ï¼è£œã„åˆãˆã‚‹é–¢ä¿‚"
    elif distance in [2, 3]:
        return "ã‚„ã‚„é•ã„ãŒã‚ã‚Šåˆºæ¿€çš„ãªé–¢ä¿‚"
    else:
        return "ç†è§£ã«æ™‚é–“ãŒã‹ã‹ã‚‹ãŒå­¦ã³ãŒå¤§ãã„"

def get_relationship_theme(n):
    themes = {
        1: "è‡ªç«‹ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®é–¢ä¿‚",
        2: "å…±æ„Ÿã¨å¯„ã‚Šæ·»ã„ã®é–¢ä¿‚",
        3: "æ¥½ã—ã•ã¨éŠã³å¿ƒã®é–¢ä¿‚",
        4: "å®‰å®šã¨ç¾å®Ÿçš„ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—",
        5: "å¤‰åŒ–ã¨åˆºæ¿€ã‚’æ±‚ã‚ã‚‹é–¢ä¿‚",
        6: "æ„›ã¨å®¶åº­çš„ãªé–¢ä¿‚",
        7: "ç²¾ç¥æ€§ã¨å¿ƒã®è·é›¢æ„Ÿã‚’å­¦ã¶é–¢ä¿‚",
        8: "æˆåŠŸã¨ç›®æ¨™é”æˆã®å”åƒé–¢ä¿‚",
        9: "å¥‰ä»•ãƒ»å­¦ã³ãƒ»é‹å‘½çš„ãªç¸",
        11: "éœŠçš„ãªæˆé•·ãƒ»ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢ä¿‚",
        22: "ç†æƒ³å®Ÿç¾ã¨å…±åŒå‰µé€ ã®é–¢ä¿‚",
        33: "ç„¡æ¡ä»¶ã®æ„›ã‚’å­¦ã³åˆã†é­‚ã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼"
    }
    return themes.get(n, "æœªçŸ¥ã®é–¢ä¿‚")

def get_number_meaning(position, n):
    meanings = {
        "life_path": {
            1: "è‡ªç«‹ã¨ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã€‚",
            2: "å”èª¿ã¨èª¿å’Œã€‚",
            3: "è¡¨ç¾åŠ›ã¨å‰µé€ æ€§ã€‚",
            4: "å®‰å®šã¨åŠªåŠ›ã€‚",
            5: "è‡ªç”±ã¨å¤‰åŒ–ã€‚",
            6: "æ„›ã¨è²¬ä»»ã€‚",
            7: "æ¢æ±‚ã¨ç²¾ç¥æ€§ã€‚",
            8: "é”æˆã¨ç¾å®Ÿæ€§ã€‚",
            9: "åšæ„›ã¨å¥‰ä»•ã€‚",
            11: "ç›´æ„Ÿã¨éœŠæ€§ã€‚",
            22: "ç†æƒ³ã®å…·ç¾åŒ–ã€‚",
            33: "ç„¡æ¡ä»¶ã®æ„›ã€‚"
        },
        "birth_day": {
            1: "ç©æ¥µçš„ã§è¡Œå‹•çš„ãªé¢ãŒå¼·èª¿ã•ã‚Œã‚‹äººã§ã™ã€‚",
            2: "å”èª¿æ€§ãŒã‚ã‚Šã€äººã¨ã®é–¢ä¿‚ã‚’å¤§åˆ‡ã«ã—ã¾ã™ã€‚",
            3: "æ˜ã‚‹ããƒ¦ãƒ¼ãƒ¢ã‚¢ã«ã‚ãµã‚Œã€å‘¨å›²ã‚’æ¥½ã—ã¾ã›ã¾ã™ã€‚",
            4: "å®‰å®šå¿—å‘ã§å …å®Ÿã€åŠªåŠ›å®¶ã‚¿ã‚¤ãƒ—ã§ã™ã€‚",
            5: "å¤‰åŒ–ã‚’å¥½ã¿ã€ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒè»½ã„äººã§ã™ã€‚",
            6: "æ€ã„ã‚„ã‚ŠãŒã‚ã‚Šã€å®¶æ—ã‚„ä»²é–“ã«å°½ãã—ã¾ã™ã€‚",
            7: "å†…çœçš„ã§æ·±ãç‰©äº‹ã‚’è€ƒãˆã‚‹çŸ¥æ€§æ´¾ã§ã™ã€‚",
            8: "ç›®æ¨™é”æˆæ„æ¬²ãŒé«˜ãã€å®Ÿå‹™èƒ½åŠ›ã«é•·ã‘ã¾ã™ã€‚",
            9: "äººã®ãŸã‚ã«å‹•ã‘ã‚‹ã€å¥‰ä»•ç²¾ç¥ã®å¼·ã„äººã§ã™ã€‚",
            11: "æ„Ÿå—æ€§ãŒé«˜ãã€ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å‹•ãäººã§ã™ã€‚",
            22: "ç†æƒ³ã‚’å½¢ã«ã™ã‚‹åŠ›ã‚’æŒã¡ã€ã‚¹ã‚±ãƒ¼ãƒ«ã®å¤§ããªæ€è€ƒã‚’ã—ã¾ã™ã€‚",
            33: "æ„›æƒ…æ·±ãã€äººã€…ã®ç™’ã—ã¨ãªã‚‹å­˜åœ¨ã§ã™ã€‚"
        },
        "expression": {
            1: "å‘¨å›²ã‹ã‚‰ã¯ãƒªãƒ¼ãƒ€ãƒ¼çš„å­˜åœ¨ã¨è¦‹ã‚‰ã‚ŒãŒã¡ã§ã™ã€‚",
            2: "èãä¸Šæ‰‹ã§ã€ã‚µãƒãƒ¼ãƒˆå½¹ã«ã¾ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚",
            3: "ãŠã—ã‚ƒã¹ã‚Šå¥½ãã§è¯ã‚„ã‹ãªå°è±¡ã‚’ä¸ãˆã¾ã™ã€‚",
            4: "ã¾ã˜ã‚ã§ä¿¡é ¼ã•ã‚Œã‚‹æ€§æ ¼ã«è¦‹ã‚‰ã‚Œã¾ã™ã€‚",
            5: "è‡ªç”±äººã§æ ã«ã¨ã‚‰ã‚ã‚Œãªã„é›°å›²æ°—ã§ã™ã€‚",
            6: "äººå½“ãŸã‚ŠãŒè‰¯ãã€å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹äººã§ã™ã€‚",
            7: "ã¡ã‚‡ã£ã¨ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã§çŸ¥çš„ãªå°è±¡ã§ã™ã€‚",
            8: "ã—ã£ã‹ã‚Šè€…ã§ç¾å®Ÿçš„ãªå°è±¡ã‚’æŒãŸã‚Œã¾ã™ã€‚",
            9: "å„ªã—ãåšæ„›çš„ãªç©ºæ°—ã‚’ã¾ã¨ã£ã¦ã„ã¾ã™ã€‚",
            11: "ç›´æ„Ÿçš„ã§ä¸æ€è­°ãªé›°å›²æ°—ãŒã‚ã‚Šã¾ã™ã€‚",
            22: "å ‚ã€…ã¨ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã®å¤§ãã•ã‚’æ„Ÿã˜ã•ã›ã¾ã™ã€‚",
            33: "å„ªã—ã•ã«æº€ã¡ã€ã¿ã‚“ãªã®æ¯ã®ã‚ˆã†ãªå­˜åœ¨ã§ã™ã€‚"
        },
        "soul": {
            1: "è‡ªåˆ†ã®åŠ›ã§é“ã‚’åˆ‡ã‚Šé–‹ããŸã„ã¨ã„ã†æ„å¿—ãŒã‚ã‚Šã¾ã™ã€‚",
            2: "äººã¨ã¤ãªãŒã‚Šã€æ”¯ãˆåˆã„ãŸã„ã¨ã„ã†é¡˜ã„ãŒã‚ã‚Šã¾ã™ã€‚",
            3: "è‡ªåˆ†ã‚’è¡¨ç¾ã—ã¦ã€æ¥½ã—ã¿ãŸã„ã¨ã„ã†æƒ³ã„ãŒã‚ã‚Šã¾ã™ã€‚",
            4: "å …å®Ÿã«åŸºç›¤ã‚’ç¯‰ããŸã„ã¨ã„ã†é¡˜ã„ãŒã‚ã‚Šã¾ã™ã€‚",
            5: "è‡ªç”±ã«å‹•ãã€åˆºæ¿€ã‚’æ±‚ã‚ãŸã„ã¨ã„ã†æƒ³ã„ãŒã‚ã‚Šã¾ã™ã€‚",
            6: "å®¶æ—ã‚„ä»²é–“ã‚’å¤§åˆ‡ã«ã—ã€å®ˆã‚ŠãŸã„ã¨ã„ã†æ°—æŒã¡ãŒã‚ã‚Šã¾ã™ã€‚",
            7: "æœ¬è³ªã‚„çœŸå®Ÿã‚’æ·±ãçŸ¥ã‚ŠãŸã„ã¨ã„ã†æ¬²æ±‚ãŒã‚ã‚Šã¾ã™ã€‚",
            8: "ç›®æ¨™ã‚’é”æˆã—ã€ç¾å®Ÿçš„ãªæˆæœã‚’å¾—ãŸã„æƒ³ã„ãŒã‚ã‚Šã¾ã™ã€‚",
            9: "äººã‚„ç¤¾ä¼šã«è²¢çŒ®ã—ãŸã„ã¨ã„ã†å¥‰ä»•ã®ç²¾ç¥ãŒã‚ã‚Šã¾ã™ã€‚",
            11: "ç›´æ„Ÿã‚„ã²ã‚‰ã‚ãã‚’å¤§åˆ‡ã«ã—ãŸã„ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚",
            22: "ç†æƒ³ã®ä¸–ç•Œã‚’å®Ÿç¾ã—ãŸã„ã¨ã„ã†å¤§ããªæ„å¿—ãŒã‚ã‚Šã¾ã™ã€‚",
            33: "ç„¡å„Ÿã®æ„›ã‚’åºƒã’ãŸã„ã¨ã„ã†é­‚ã®é¡˜ã„ãŒã‚ã‚Šã¾ã™ã€‚"
        }
    }
    return meanings.get(position, {}).get(n, "æ„å‘³ãŒæœªè¨­å®šã§ã™ã€‚")

# ã‚¢ãƒ—ãƒªæœ¬ä½“
st.title("ğŸ”¢ æ•°ç§˜è¡“è¨ºæ–­ã‚¢ãƒ—ãƒª")

tab1, tab2 = st.tabs(["ğŸ§‘â€ğŸ’¼ è‡ªå·±è¨ºæ–­", "ğŸ’‘ ç›¸æ€§è¨ºæ–­"])

with tab1:
    name = st.text_input("åå‰ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰")
    birthdate = st.date_input("ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠ", min_value=datetime.date(1925, 1, 1), max_value=datetime.date(2025, 12, 31))

    if st.button("è¨ºæ–­ã™ã‚‹"):
        if name:
            lp = calculate_life_path_number(birthdate)
            bd = calculate_birth_day_number(birthdate.day)
            ex = calculate_expression_number(name)
            su = calculate_soul_urge_number(name)

            st.subheader("ğŸ”® è¨ºæ–­çµæœ")
            st.write(f"é‹å‘½æ•°ï¼š{lp} â†’ {get_number_meaning('life_path', lp)}")
            st.write(f"èª•ç”Ÿæ•°ï¼š{bd} â†’ {get_number_meaning('birth_day', bd)}")
            st.write(f"è¡¨ç¾æ•°ï¼š{ex} â†’ {get_number_meaning('expression', ex)}")
            st.write(f"é­‚ã®æ¬²æ±‚æ•°ï¼š{su} â†’ {get_number_meaning('soul', su)}")

            nums = [lp, bd, ex, su]
            for n, c in Counter(nums).items():
                if c > 1:
                    st.info(f"{n} ãŒè¤‡æ•°ç™»å ´ â†’ å½±éŸ¿ãŒå¼·ã„æ•°å­—ã§ã™")
        else:
            st.warning("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

with tab2:
    st.subheader("ğŸ’‘ ç›¸æ€§è¨ºæ–­")
    col1, col2 = st.columns(2)
    with col1:
        your_name = st.text_input("ã‚ãªãŸã®åå‰ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰", key="your_name")
        your_birth = st.date_input("ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥", min_value=datetime.date(1925, 1, 1), max_value=datetime.date(2025, 12, 31), key="your_birth")
    with col2:
        partner_name = st.text_input("ç›¸æ‰‹ã®åå‰ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰", key="partner_name")
        partner_birth = st.date_input("ç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥", min_value=datetime.date(1925, 1, 1), max_value=datetime.date(2025, 12, 31), key="partner_birth")

    if st.button("ç›¸æ€§ã‚’è¨ºæ–­"):
        you = calculate_life_path_number(your_birth)
        partner = calculate_life_path_number(partner_birth)
        total = reduce_number(you + partner)
        relation = evaluate_compatibility(you, partner)
        theme = get_relationship_theme(total)

        st.subheader("ğŸ”— ç›¸æ€§è¨ºæ–­çµæœ")
        st.write(f"ã‚ãªãŸã®é‹å‘½æ•°ï¼š{you}")
        st.write(f"ç›¸æ‰‹ã®é‹å‘½æ•°ï¼š{partner}")
        st.write(f"ç›¸æ€§ã‚¿ã‚¤ãƒ—ï¼š{relation}")
        st.write(f"ãµãŸã‚Šã®é–¢ä¿‚æ€§ãƒ†ãƒ¼ãƒï¼ˆåˆè¨ˆæ•° {total}ï¼‰ï¼š{theme}")
